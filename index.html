<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goated Proposal ‚Äî Single File</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&family=Great+Vibes&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#ff758c; --bg2:#ff9a9e; --glass: rgba(255,255,255,0.12);
    --accent:#ff527b; --muted:#efeff2;
    --card-radius:18px;
  }
  *{box-sizing:border-box}
  body{
    min-height:100vh;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:'Poppins',sans-serif;
    display:flex;align-items:center;justify-content:center;padding:20px;
  }
  .wrap{width:100%;max-width:980px;margin:0 auto;}
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border-radius:20px;padding:22px;color:#fff;backdrop-filter: blur(8px);
    box-shadow:0 10px 40px rgba(0,0,0,0.2);
    margin-bottom:18px;
  }

  .row{display:flex;gap:12px;flex-wrap:wrap}
  label{font-size:13px;color:#ffecec;margin-bottom:6px;display:block}
  input[type=text], input[type=number], select, textarea{
    width:100%;padding:10px;border-radius:10px;border:none;outline:none;font-size:14px;
    background:rgba(255,255,255,0.12);color:#fff;
  }
  textarea{min-height:90px;resize:vertical;padding-top:12px}
  .two{flex:1 1 48%}
  .full{flex:1 1 100%}

  h1{font-family:'Great Vibes',cursive;font-size:36px;margin:6px 0 2px}
  p.lead{color:#ffe6ea;margin-bottom:12px}

  .btn{
    display:inline-block;padding:10px 16px;border-radius:999px;border:none;background:var(--accent);
    color:#fff;font-weight:700;cursor:pointer;margin:6px 6px 0;box-shadow:0 6px 18px rgba(0,0,0,0.18);
  }
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12)}
  .muted{color:rgba(255,255,255,0.75);font-size:13px}

  .hidden{display:none !important}
  .center{text-align:center}
  .link-box{background:rgba(0,0,0,0.15);padding:10px;border-radius:10px;color:#fff;word-break:break-all;margin-top:8px}

  /* Proposal card */
  .proposal-card{display:block;background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));padding:20px;border-radius:16px}
  .proposal-title{font-family:'Great Vibes',cursive;font-size:34px;margin-bottom:6px}
  .proposal-msg{white-space:pre-line;margin-top:8px;color:#fff;}

  /* response area */
  #responseBox{margin-top:14px;font-size:18px;color:#fff;font-weight:600}

  /* chatbot */
  .chat-wrap{height:420px;background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;display:flex;flex-direction:column}
  .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:10px}
  .msg.user{align-self:flex-end;background:linear-gradient(90deg,#6dd3ff,#4da6ff);color:#022;font-padding:10px;border-radius:14px 14px 6px 14px;padding:10px 12px;max-width:80%}
  .msg.bot{align-self:flex-start;background:rgba(255,255,255,0.9);color:#111;padding:10px;border-radius:14px 14px 14px 6px;max-width:80%}
  .chat-input{display:flex;gap:8px;margin-top:8px}
  .chat-input input{flex:1;padding:10px;border-radius:10px;border:none}
  .mode-toggle{display:flex;gap:10px;align-items:center;margin-bottom:8px}

  /* responsive */
  @media (max-width:720px){
    .two{flex-basis:100%}
    h1{font-size:30px}
    .chat-wrap{height:360px}
  }

  /* small */
  .small-muted{font-size:12px;color:rgba(255,255,255,0.8)}
  img.proof{max-width:220px;border-radius:12px;margin-top:12px;display:block;margin-left:auto;margin-right:auto}
</style>
</head>
<body>
  <canvas id="confetti" style="position:fixed;left:0;top:0;pointer-events:none;z-index:9999"></canvas>
  <div class="wrap">

    <!-- Phase 1 & 2: Creator & Partner form -->
    <div id="formPanel" class="panel">
      <div class="center">
        <h1>üíå Goated Proposal</h1>
        <p class="lead">Phase 1: Creator details ‚Äî fill carefully. Under 18? You cannot create.</p>
      </div>

      <form id="multiForm">
        <div class="row">
          <div class="two">
            <label>Your name</label>
            <input id="creatorName" name="creatorName" type="text" placeholder="e.g., Rahul" required>
          </div>
          <div class="two">
            <label>Your gender</label>
            <select id="creatorGender" required>
              <option value="">Select gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="two">
            <label>Your age</label>
            <input id="creatorAge" name="creatorAge" type="number" min="1" placeholder="e.g., 22" required>
          </div>
          <div class="two">
            <label>Relationship intent</label>
            <select id="intent" required>
              <option value="">Choose</option>
              <option value="serious">Serious Relationship</option>
              <option value="casual">Casual / Fun</option>
            </select>
          </div>

          <div class="full" style="margin-top:10px">
            <hr style="border:none;height:1px;background:rgba(255,255,255,0.06);margin:8px 0">
            <p class="lead">Phase 2: Partner details</p>
          </div>

          <div class="two">
            <label>Partner name</label>
            <input id="partnerName" name="partnerName" type="text" placeholder="e.g., Priya" required>
          </div>
          <div class="two">
            <label>Partner gender</label>
            <select id="partnerGender" required>
              <option value="">Select gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="two">
            <label>Partner age</label>
            <input id="partnerAge" name="partnerAge" type="number" min="1" placeholder="e.g., 21" required>
          </div>
          <div class="two">
            <label>Short personal line (optional)</label>
            <input id="shortLine" type="text" placeholder="Remember that trip to ...">
          </div>

          <div class="full">
            <label>Long message (optional)</label>
            <textarea id="longMsg" placeholder="Write something sweet..."></textarea>
          </div>

          <div class="full center" style="margin-top:6px">
            <button type="submit" class="btn">Create Proposal & Generate Link</button>
            <button type="button" id="previewBtn" class="btn ghost">Preview Locally</button>
          </div>

          <div id="linkArea" class="full hidden">
            <p class="small-muted">Shareable link (send to partner):</p>
            <div class="link-box" id="shareLink"></div>
            <div style="margin-top:8px">
              <button id="copyLinkBtn" class="btn ghost">Copy</button>
              <button id="waShare" class="btn ghost">Share WhatsApp</button>
              <button id="mailShare" class="btn ghost">Share Gmail</button>
            </div>
            <p class="muted" style="margin-top:10px;font-size:13px">All form data (creator + partner + short message) will also be sent to creator's configured Formspree (for your inbox)</p>
          </div>

        </div>
      </form>
    </div>

    <!-- Phase 3: Proposal view -->
    <div id="proposalPanel" class="panel hidden">
      <div class="proposal-card center">
        <div class="proposal-title" id="proposalTitle">For You</div>
        <div id="proposalNames" class="muted"></div>
        <div id="proposalShort" class="muted" style="margin-top:6px"></div>
        <div id="proposalMsg" class="proposal-msg"></div>

        <div style="margin-top:12px">
          <button id="yesBtn" class="btn">üíç Yes</button>
          <button id="noBtn" class="btn ghost">üôà No</button>
        </div>

        <div id="responseBox"></div>

        <div id="yesArea" class="hidden center" style="margin-top:12px">
          <img src="sorry sorry.jpg" alt="sorry" class="proof" id="sorryImg" onerror="this.style.display='none'"/>
          <div id="genderMessage" style="margin-top:12px;font-size:20px;font-weight:700"></div>
          <div style="margin-top:10px"><button id="nextToChat" class="btn">Next ‚Üí Astrologer Chat</button></div>
        </div>

        <div style="margin-top:14px" id="shareArea" class="hidden">
          <p class="small-muted">Direct link (same):</p>
          <div class="link-box" id="shareLink2"></div>
          <div style="margin-top:8px">
            <button id="copyLinkBtn2" class="btn ghost">Copy</button>
            <button id="waShare2" class="btn ghost">WhatsApp</button>
            <button id="mailShare2" class="btn ghost">Gmail</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Phase 4: Chatbot -->
    <div id="chatPanel" class="panel hidden">
      <div class="center">
        <h1 style="font-size:28px">üîÆ Couple Astrologer</h1>
        <div class="mode-toggle" style="justify-content:center">
          <label class="small-muted">Mode:</label>
          <select id="chatMode">
            <option value="romantic">Romantic Astrology</option>
            <option value="mix">Romantic + Funny Mix</option>
          </select>
          <div style="margin-left:12px" class="small-muted">Type message & press Send</div>
        </div>
      </div>

      <div class="chat-wrap" id="chatWrap">
        <div class="messages" id="messages"></div>
        <div class="chat-input">
          <input id="chatInput" placeholder="Ask the astrologer (eg. Will our marriage be successful?)">
          <button id="sendChat" class="btn">Send</button>
        </div>
      </div>

      <div style="margin-top:12px" class="center">
        <button id="finishBtn" class="btn">Finish & Leave Feedback</button>
      </div>
    </div>

    <!-- Phase 5: Feedback -->
    <div id="feedbackPanel" class="panel hidden">
      <div class="center"><h1 style="font-size:26px">‚úçÔ∏è Final Feedback</h1>
        <p class="small-muted">Your reply and feedback will be sent to the creator (via Formspree).</p>
      </div>

      <form id="finalFeedbackForm">
        <div class="row">
          <div class="two">
            <label>Your name (replying)</label>
            <input id="fbName" type="text" placeholder="Your name">
          </div>
          <div class="two">
            <label>Your email</label>
            <input id="fbEmail" type="text" placeholder="you@example.com">
          </div>
          <div class="full">
            <label>Your message / reply</label>
            <textarea id="fbMessage" placeholder="Write your reply..."></textarea>
          </div>
          <div class="full center" style="margin-top:8px">
            <button type="submit" class="btn">Send Reply</button>
            <button type="button" id="restartBtn" class="btn ghost">Start Over</button>
          </div>
          <div id="fbStatus" class="full muted" style="margin-top:8px"></div>
        </div>
      </form>
    </div>

  </div>

<script>
(function(){
  const FORMSPREE = 'https://formspree.io/f/xrbanzwa';

  // elements
  const multiForm = document.getElementById('multiForm');
  const linkArea = document.getElementById('linkArea');
  const shareLink = document.getElementById('shareLink');
  const copyLinkBtn = document.getElementById('copyLinkBtn');
  const waShare = document.getElementById('waShare');
  const mailShare = document.getElementById('mailShare');
  const previewBtn = document.getElementById('previewBtn');

  const formPanel = document.getElementById('formPanel');
  const proposalPanel = document.getElementById('proposalPanel');
  const proposalNames = document.getElementById('proposalNames');
  const proposalShort = document.getElementById('proposalShort');
  const proposalMsg = document.getElementById('proposalMsg');
  const yesBtn = document.getElementById('yesBtn');
  const noBtn = document.getElementById('noBtn');
  const responseBox = document.getElementById('responseBox');
  const yesArea = document.getElementById('yesArea');
  const genderMessage = document.getElementById('genderMessage');
  const nextToChat = document.getElementById('nextToChat');
  const shareArea = document.getElementById('shareArea');
  const shareLink2 = document.getElementById('shareLink2');
  const copyLinkBtn2 = document.getElementById('copyLinkBtn2');
  const waShare2 = document.getElementById('waShare2');
  const mailShare2 = document.getElementById('mailShare2');

  const chatPanel = document.getElementById('chatPanel');
  const chatMode = document.getElementById('chatMode');
  const messagesEl = document.getElementById('messages');
  const chatInput = document.getElementById('chatInput');
  const sendChat = document.getElementById('sendChat');
  const finishBtn = document.getElementById('finishBtn');

  const feedbackPanel = document.getElementById('feedbackPanel');
  const finalFeedbackForm = document.getElementById('finalFeedbackForm');
  const fbStatus = document.getElementById('fbStatus');
  const restartBtn = document.getElementById('restartBtn');

  // form fields
  const creatorName = document.getElementById('creatorName');
  const creatorGender = document.getElementById('creatorGender');
  const creatorAge = document.getElementById('creatorAge');
  const intent = document.getElementById('intent');
  const partnerName = document.getElementById('partnerName');
  const partnerGender = document.getElementById('partnerGender');
  const partnerAge = document.getElementById('partnerAge');
  const shortLine = document.getElementById('shortLine');
  const longMsg = document.getElementById('longMsg');

  // final panels
  const fbName = document.getElementById('fbName');
  const fbEmail = document.getElementById('fbEmail');
  const fbMessage = document.getElementById('fbMessage');

  // confetti canvas
  const confettiCanvas = document.getElementById('confetti');
  const confettiCtx = confettiCanvas.getContext('2d');
  let confettiPieces = [];
  function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();

  function random(min,max){ return Math.random()*(max-min)+min; }
  function makePiece(){ return { x: random(0,confettiCanvas.width), y: random(-confettiCanvas.height,0), w: random(6,12), h: random(8,16), c: `hsl(${random(0,360)},80%,60%)`, s: random(2,5) }; }
  function startConfetti(){
    confettiPieces = Array.from({length:140}, makePiece);
    (function draw(t){
      confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
      confettiPieces.forEach((p,i)=>{
        confettiCtx.fillStyle = p.c;
        confettiCtx.fillRect(p.x,p.y,p.w,p.h);
        p.y += p.s + Math.sin((t+i)/100);
        p.x += Math.sin((t+i)/150);
        if(p.y > confettiCanvas.height) confettiPieces[i] = makePiece();
      });
      requestAnimationFrame(draw);
    })(0);
    setTimeout(()=>{ confettiPieces = []; confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); }, 7000);
  }

  // util: show panel
  function showPanel(panel){
    [formPanel, proposalPanel, chatPanel, feedbackPanel].forEach(p=>p.classList.add('hidden'));
    panel.classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // build share link from current values
  function buildShareLink(data){
    const base = window.location.origin + window.location.pathname.split('/').pop().replace('index.html','') || window.location.origin + '/';
    // we will create a link that includes query params so opening opens the proposal directly
    const url = new URL(window.location.href.split('?')[0]);
    // set params
    url.searchParams.set('from', data.creatorName);
    url.searchParams.set('fromGender', data.creatorGender);
    url.searchParams.set('fromAge', data.creatorAge);
    url.searchParams.set('to', data.partnerName);
    url.searchParams.set('toGender', data.partnerGender);
    url.searchParams.set('toAge', data.partnerAge);
    if(data.shortLine) url.searchParams.set('short', data.shortLine);
    if(data.longMsg) url.searchParams.set('msg', data.longMsg);
    if(data.intent) url.searchParams.set('intent', data.intent);
    return url.toString();
  }

  // send to Formspree (helper)
  async function sendToFormspree(payload){
    try{
      await fetch(FORMSPREE, {
        method:'POST',
        headers:{ 'Accept':'application/json','Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      return true;
    }catch(e){
      console.warn('Formspree error', e);
      return false;
    }
  }

  // initial validation and form submit -> generate link + show proposal view
  multiForm.addEventListener('submit', async function(e){
    e.preventDefault();
    // validate ages
    const cAge = Number(creatorAge.value);
    const pAge = Number(partnerAge.value);
    if(!creatorName.value.trim() || !partnerName.value.trim()){
      alert('Please fill both names');
      return;
    }
    if(isNaN(cAge) || cAge <= 0){ alert('Enter a valid creator age'); return; }
    if(isNaN(pAge) || pAge <= 0){ alert('Enter a valid partner age'); return; }

    if(cAge < 18){ alert('You must be 18 or older to create a proposal.'); return; }
    if(pAge < 18){ alert('Partner must be 18 or older to proceed.'); return; }

    // everything OK -> prepare data
    const data = {
      creatorName: creatorName.value.trim(),
      creatorGender: creatorGender.value,
      creatorAge: cAge,
      intent: intent.value,
      partnerName: partnerName.value.trim(),
      partnerGender: partnerGender.value,
      partnerAge: pAge,
      shortLine: shortLine.value.trim(),
      longMsg: longMsg.value.trim()
    };

    // show proposal UI
    showProposalFromData(data);

    // send initial creation data to Formspree (so you get who created & who for)
    const payload = {
      type: 'proposal_created',
      timestamp: new Date().toISOString(),
      creatorName: data.creatorName,
      creatorGender: data.creatorGender,
      creatorAge: data.creatorAge,
      partnerName: data.partnerName,
      partnerGender: data.partnerGender,
      partnerAge: data.partnerAge,
      shortLine: data.shortLine,
      longMsg: data.longMsg,
      intent: data.intent,
      note: 'Initial creation ‚Äî link generated'
    };
    sendToFormspree(payload); // fire and forget

    // build share link and show
    const link = buildShareLink(data);
    shareLink.innerText = link;
    shareLink2.innerText = link;
    linkArea.classList.remove('hidden');
    shareArea.classList.remove('hidden');
  });

  previewBtn.addEventListener('click', function(){
    // do same validation but do not send
    const cAge = Number(creatorAge.value);
    const pAge = Number(partnerAge.value);
    if(cAge < 18 || pAge < 18){ alert('Both must be 18+ to preview'); return; }
    const data = {
      creatorName: creatorName.value.trim() || 'Someone',
      creatorGender: creatorGender.value || 'other',
      creatorAge: cAge || '',
      partnerName: partnerName.value.trim() || 'You',
      partnerGender: partnerGender.value || 'other',
      partnerAge: pAge || '',
      shortLine: shortLine.value.trim(),
      longMsg: longMsg.value.trim()
    };
    showProposalFromData(data);
  });

  function showProposalFromData(data){
    showPanel(proposalPanel);
    proposalNames.innerText = `${data.creatorName} ‚ûù ${data.partnerName}`;
    proposalShort.innerText = data.shortLine || '';
    proposalMsg.innerText = data.longMsg || `Zindagi ne yeh sikha diya...ki sab aapke hain, par apne kaam ke waqt hi.\n\n${data.creatorName ? data.creatorName + ' says: ' : ''}I love you.`;
    // store current data on window for later use
    window.__proposalData = data;
    responseBox.innerText = '';
    yesArea.classList.add('hidden');
    shareArea.classList.remove('hidden');
  }

  // copy link functions
  copyLinkBtn.addEventListener('click', ()=> { navigator.clipboard.writeText(shareLink.innerText||'').then(()=>copyLinkBtn.innerText='Copied!'); setTimeout(()=>copyLinkBtn.innerText='Copy',1500); });
  copyLinkBtn2.addEventListener('click', ()=> { navigator.clipboard.writeText(shareLink2.innerText||'').then(()=>copyLinkBtn2.innerText='Copied!'); setTimeout(()=>copyLinkBtn2.innerText='Copy',1500); });
  waShare.addEventListener('click', ()=> { window.open('https://wa.me/?text='+encodeURIComponent('Open this proposal: '+(shareLink.innerText||'')),'_blank'); });
  waShare2.addEventListener('click', ()=> { window.open('https://wa.me/?text='+encodeURIComponent('Open this proposal: '+(shareLink2.innerText||'')),'_blank'); });
  mailShare.addEventListener('click', ()=> { window.open('mailto:?subject='+encodeURIComponent('A special proposal')+'&body='+encodeURIComponent('Open: '+(shareLink.innerText||'')),'_blank'); });
  mailShare2.addEventListener('click', ()=> { window.open('mailto:?subject='+encodeURIComponent('A special proposal')+'&body='+encodeURIComponent('Open: '+(shareLink2.innerText||'')),'_blank'); });

  // Yes / No logic
  const rejectionMessages = [
    "Arre koi baat nahi, coffee pe bula lena ‚òï",
    "Theek hai, baad me baat karte hain ‚Äî all the best!",
    "No problem ‚Äî life me aur bhi surprises hain üòÇ",
    "Tumhari choice respect. Khush raho!"
  ];

  noBtn.addEventListener('click', ()=>{
    const r = rejectionMessages[Math.floor(Math.random()*rejectionMessages.length)];
    responseBox.innerText = r;
    // small shake effect
    noBtn.animate([{transform:'translateY(0)'},{transform:'translateY(-8px)'},{transform:'translateY(0)'}],{duration:300});
  });

  yesBtn.addEventListener('click', ()=>{
    const data = window.__proposalData || {};
    // show gender-specific message
    const g = (data.partnerGender||'other').toLowerCase();
    let msg = '';
    if(g === 'female') msg = 'Chal na bevdiii ‚ù§Ô∏è';
    else if(g === 'male') msg = 'Chal na bevdaa salla!! üçª';
    else msg = 'Chal na, kyun nahi! üíñ';

    genderMessage.innerText = msg;
    yesArea.classList.remove('hidden');
    responseBox.innerText = msg;
    // confetti
    startConfetti();

    // log yes action to Formspree
    const payload = {
      type:'proposal_accepted',
      timestamp: new Date().toISOString(),
      creatorName: data.creatorName,
      creatorGender: data.creatorGender,
      creatorAge: data.creatorAge,
      partnerName: data.partnerName,
      partnerGender: data.partnerGender,
      partnerAge: data.partnerAge,
      messageShown: msg
    };
    sendToFormspree(payload);
  });

  // Next to chat
  nextToChat.addEventListener('click', ()=>{
    showPanel(chatPanel);
    // initial bot greeting
    addBotMsg(`Hello! I am the CoupleAstro Bot. Mode: ${chatMode.value === 'mix' ? 'Romantic + Funny' : 'Romantic Astrology'}. Ask anything about your relationship!`);
  });

  // Chatbot logic - interactive typing
  const romanticReplies = [
    "Stars show deep harmony ‚Äî tum dono ki frequency match karti hai ‚ú®",
    "Aane wale saalon mein saathiness strong rahegi ‚Äî keep caring.",
    "Rahu aur Venus alignment suggests affection & attraction is mutual.",
    "Aap dono shared values rakhte ho ‚Äî strong couple bond ahead."
  ];
  const mixReplies = [
    "Pyaar high hai, and your pizza-sharing score is 99% üçïüòÇ",
    "Universe says: 'Share the last bite' ‚Äî that's destiny!",
    "Your compatibility is so strong, even your phone battery will last longer together üîã‚ù§Ô∏è",
    "Romance 80%, memes 100% ‚Äî a perfect combo."
  ];

  function addUserMsg(text){
    const el = document.createElement('div'); el.className='msg user'; el.innerText=text;
    messagesEl.appendChild(el); messagesEl.scrollTop = messagesEl.scrollHeight;
  }
  function addBotMsg(text){
    const el = document.createElement('div'); el.className='msg bot';
    // simulate typing
    el.innerText = '...';
    messagesEl.appendChild(el); messagesEl.scrollTop = messagesEl.scrollHeight;
    setTimeout(()=>{ el.innerText = text; messagesEl.scrollTop = messagesEl.scrollHeight; }, 600 + Math.random()*800);
  }

  sendChat.addEventListener('click', sendChatHandler);
  chatInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); sendChatHandler(); } });

  function sendChatHandler(){
    const text = chatInput.value.trim();
    if(!text) return;
    addUserMsg(text);
    chatInput.value = '';
    // choose response based on mode
    const mode = chatMode.value;
    let reply = '';
    if(mode === 'romantic'){
      reply = romanticReplies[Math.floor(Math.random()*romanticReplies.length)];
    } else {
      // mix: randomly pick romantic or mix but heavier on mix
      reply = Math.random() < 0.6 ? mixReplies[Math.floor(Math.random()*mixReplies.length)] : romanticReplies[Math.floor(Math.random()*romanticReplies.length)];
    }
    addBotMsg(reply);
    // store chat in window for sending later
    window.__chatLog = window.__chatLog || [];
    window.__chatLog.push({from:'user',text}); window.__chatLog.push({from:'bot',text:reply});
  }

  finishBtn.addEventListener('click', ()=> showPanel(feedbackPanel));

  // feedback form submit -> send everything to Formspree
  finalFeedbackForm.addEventListener('submit', async function(e){
    e.preventDefault();
    const data = window.__proposalData || {};
    const payload = {
      type: 'final_feedback',
      timestamp: new Date().toISOString(),
      creatorName: data.creatorName,
      creatorGender: data.creatorGender,
      creatorAge: data.creatorAge,
      partnerName: data.partnerName,
      partnerGender: data.partnerGender,
      partnerAge: data.partnerAge,
      shortLine: data.shortLine,
      longMsg: data.longMsg,
      replyerName: fbName.value,
      replyerEmail: fbEmail.value,
      replyMessage: fbMessage.value,
      chatLog: window.__chatLog || [],
      note: 'Final reply from partner'
    };
    fbStatus.innerText = 'Sending...';
    const ok = await sendToFormspree(payload);
    if(ok){ fbStatus.innerText = 'Reply sent. Thank you!'; finalFeedbackForm.reset(); }
    else fbStatus.innerText = 'Could not send ‚Äî check network.';
  });

  restartBtn.addEventListener('click', ()=> location.href = location.pathname);

  // --- When someone opens via share link (query params), auto-fill and show proposal ---
  function loadFromParams(){
    const params = new URLSearchParams(window.location.search);
    if(params.has('from') && params.has('to')){
      // parse and pre-fill internal data
      const data = {
        creatorName: params.get('from'),
        creatorGender: params.get('fromGender') || 'other',
        creatorAge: params.get('fromAge') || '',
        partnerName: params.get('to'),
        partnerGender: params.get('toGender') || 'other',
        partnerAge: params.get('toAge') || '',
        shortLine: params.get('short') || '',
        longMsg: params.get('msg') || ''
      };
      window.__proposalData = data;
      // We still must hide the form and show proposal panel
      showProposalFromData(data);
      // update share link boxes
      shareLink.innerText = window.location.href;
      shareLink2.innerText = window.location.href;
      linkArea.classList.remove('hidden'); shareArea.classList.remove('hidden');
    }
  }
  loadFromParams();

  // small UX: when proposal visible, clicking copy etc should still work
  // Also allow mouseclick on proposal names to show creator details (optional)
  proposalNames.addEventListener('click', ()=> alert('Creator and Partner names displayed above.'));

  // Accessibility small improvements
  chatInput.setAttribute('aria-label','Chat input');

  // Done
})();
</script>
</body>
</html>
